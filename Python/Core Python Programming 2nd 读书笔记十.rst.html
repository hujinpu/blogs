<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title></title>
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2005-12-18 01:56:14 +0100 (Sun, 18 Dec 2005) $
:Revision: $Revision: 4224 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left {
  clear: left }

img.align-right {
  clear: right }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document">
<!-- -*- mode: rst -*- -->
<p>第十章：错误和异常</p>
<p>本章主题：</p>
<ul class="simple">
<li>什么是异常？</li>
<li>Python 中的异常</li>
<li>探测和处理异常</li>
<li>上下文管理</li>
<li>引发异常</li>
<li>断言</li>
<li>标准异常</li>
<li>创建异常</li>
<li>相关模块</li>
</ul>
<p><tt class="docutils literal"><span class="pre">try</span></tt> 语句块中异常发生点后的剩余语句永远不会到达（所以也永远不会执行）。 一旦一个异常被引发，就必须决定控制流下一步到达的位置。剩余代码将被忽略，解释器将搜索异常处理器（except里的代码），一旦找到，就开始执行处理器中的代码。如果没有找到合适的处理器，那么异常就向上移交给调用者去处理，这意味着堆栈框架立即回到之前的那个。如果在上层调用者也没找到对应处理器，该异常会继续被向上移交，直到找到合适处理器。如果到达最顶层仍然没有找到对应处理器，那么就认为这个异常是未处理的，Python解释器会显示出跟踪返回消息，然后退出。</p>
<p><strong>当函数没有显式地返回一个值时，例如没有执行到</strong> <tt class="docutils literal"><span class="pre">return</span> <span class="pre">object</span></tt> <strong>语句函数就结束了，它就返回</strong> <tt class="docutils literal"><span class="pre">None</span></tt></p>
<pre class="literal-block">
&gt;&gt;&gt; def test():
...     a = 1 + 1
...
&gt;&gt;&gt; b = test()
&gt;&gt;&gt; b
&gt;&gt;&gt; print b
None
</pre>
<p>处理异常可用多个 <tt class="docutils literal"><span class="pre">except</span></tt> 语句，也可以在一个 <tt class="docutils literal"><span class="pre">except</span></tt> 语句里以元组的方式传入多个异常类，如这样： <tt class="docutils literal"><span class="pre">except</span> <span class="pre">(Exc1[,</span> <span class="pre">Exc2[,</span> <span class="pre">...</span> <span class="pre">ExcN]])[,</span> <span class="pre">reason]</span></tt></p>
<p>要一次捕获所有的异常只要捕获 <tt class="docutils literal"><span class="pre">Exception</span></tt> 类就好了，极端点也可以是一个裸 <tt class="docutils literal"><span class="pre">except:</span></tt> ，但这种裸 <tt class="docutils literal"><span class="pre">except</span></tt> 已不被推荐使用了，事实上，到了Python 2.5由于异常类层次结构的变化，这样也不会真正处理所有的异常，因为异常 <tt class="docutils literal"><span class="pre">KeyboardInterrupt</span></tt> 和 <tt class="docutils literal"><span class="pre">SystemExit</span></tt> 被抽出了 <tt class="docutils literal"><span class="pre">Exception</span></tt> ，现在的结构是：</p>
<ul class="simple">
<li>BaseException<ul>
<li>KeyboardInterrupt</li>
<li>SystemExit</li>
<li>Exception</li>
<li>(all other current built-in exceptions)所有当前内建异常</li>
</ul>
</li>
</ul>
<p>所以如果你确实需要捕获所有异常，那么你就得使用新的 <tt class="docutils literal"><span class="pre">BaseException</span></tt></p>
<p><tt class="docutils literal"><span class="pre">reason</span></tt> 将会是一个包含来自导致异常的代码的诊断信息的类实例。异常参数自身会组成一个元组，并存储为类实例（异常类的实例）的属性。</p>
<p>注意：对于 <tt class="docutils literal"><span class="pre">try-finally</span></tt> 语句，当在 <tt class="docutils literal"><span class="pre">try</span></tt> 范围中产生一个异常时，会立即跳转到 <tt class="docutils literal"><span class="pre">finally</span></tt> 语句段。当 <tt class="docutils literal"><span class="pre">finally</span></tt> 中的所有代码都执行完毕后，会继续向上一层引发异常。但如果 <tt class="docutils literal"><span class="pre">finally</span></tt> 中的代码引发了另一个异常或由于 <tt class="docutils literal"><span class="pre">return</span></tt> ， <tt class="docutils literal"><span class="pre">break</span></tt> ， <tt class="docutils literal"><span class="pre">continue</span></tt> 语法而终止，原来的异常将丢失而且无法重新引发。</p>
<p><strong>记住：最重要的是无论你选择什么语法，你至少要有一个</strong> <tt class="docutils literal"><span class="pre">except</span></tt> <strong>子句</strong></p>
<p>Python 2.6 会正式引入 <tt class="docutils literal"><span class="pre">with</span></tt> 。如果你想在Python 2.5使用 <tt class="docutils literal"><span class="pre">with</span></tt> 语句，你必须用 <tt class="docutils literal"><span class="pre">from</span> <span class="pre">__future__</span> <span class="pre">import</span> <span class="pre">with_statement</span></tt> 来导入它。</p>
<p><tt class="docutils literal"><span class="pre">with</span></tt> 语句的目标就是是保证共享的资源的唯一分配，并在任务结束的时候释放它。比如文件（数据、日志、数据库等等），线程资源、简单同步、数据库连接，等等。</p>
<p>然而， <tt class="docutils literal"><span class="pre">with</span></tt> 语句的目的在于从流程图中把 <tt class="docutils literal"><span class="pre">try</span></tt> ， <tt class="docutils literal"><span class="pre">except</span></tt> 和 <tt class="docutils literal"><span class="pre">finally</span></tt> 关键字和资源分配释放相关代码统统去掉，而不是像 <tt class="docutils literal"><span class="pre">try-except-else-finally</span></tt> 那样仅仅简化代码使之易用， <tt class="docutils literal"><span class="pre">with</span></tt> 隐藏了大量底层细节，使用你的程序更加 <cite>Pythonic</cite> （在许多的其他特性之外，更加写地轻松，读地自在） 。这是一个例子：</p>
<pre class="literal-block">
with open('/etc/passwd', 'r') as f:
    for eachLine in f:
        # ...do stuff with eachLine or f...
</pre>
<p>触发异常使用 <tt class="docutils literal"><span class="pre">raise</span> <span class="pre">[SomeException</span> <span class="pre">[,</span> <span class="pre">args</span> <span class="pre">[,</span> <span class="pre">traceback]]]</span></tt></p>
<ul class="simple">
<li>第一个参数SomeExcpetion，是触发异常的名字。如果有，它必须是一个字符串，类或实例</li>
<li>第二个参数为可选的args，可以是一个单独的对象也可以是一个对象的元组，当异常发生时，异常的参数总是作为一个元组传入</li>
<li>最后一项参数，traceback，同样是可选的如果有的话，则是当异常触发时新生成的一个用于异常-正常化(exception—normally)的追踪(traceback)对象</li>
</ul>
<p>断言 <tt class="docutils literal"><span class="pre">assert</span></tt> 是一句必须等价于布尔真的判定，此外，发生异常也意味着表达式为假。</p>
<p>sys.exc_info()得到的元组中是：</p>
<ol class="arabic simple">
<li>exc_type: 异常类</li>
<li>exc_value: 异常类的实例</li>
<li>exc_traceback: 追踪(traceback)对象</li>
</ol>
<pre class="literal-block">
&gt;&gt;&gt; try:
...     float('abc123')
... except:
...     import sys
...     exc_tuple = sys.exc_info()
...
&gt;&gt;&gt; for el in exc_tuple:
...     print el
...
&lt;type 'exceptions.ValueError'&gt;
invalid literal for float(): abc123
&lt;traceback object at 0x00AFB440&gt;
</pre>
</div>
</body>
</html>
